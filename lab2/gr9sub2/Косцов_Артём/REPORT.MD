# Лабораторная работа 2: Процессы и файловая система `/proc`

Лабораторная работа для 2-го курса, направленная на изучение процессов в Linux, их создания, а также анализа информации о процессах через файловую систему `/proc`. В рамках работы рассматриваются принципы порождения процессов, их мониторинг и извлечение данных из `/proc`.

## Цель
Изучить модель процессов Linux, освоить создание и ожидание завершения процессов, а также научиться извлекать информацию о процессах из `/proc`.

## Задание 1: Создание процессов

### Описание
Написать программу на Python, в которой родительский процесс создаёт два дочерних процесса с помощью `os.fork()`. Каждый дочерний процесс выводит свой PID и PPID, а родительский процесс ожидает их завершения с помощью `os.waitpid()` и выводит коды завершения.

### Шаги выполнения
1. Родительский процесс выводит свой PID и сообщение о начале работы.
2. С помощью `os.fork()` создаётся первый дочерний процесс (Child_A).
   - В ветке потомка (pid1 == 0) выводятся его PID и PPID, после чего процесс завершается с кодом 0.
3. Родительский процесс выполняет второй вызов `os.fork()` для создания второго дочернего процесса (Child_B).
   - В ветке потомка (pid2 == 0) выводятся его PID и PPID, процесс завершается.
4. Родительский процесс использует `os.waitpid()` для ожидания завершения обоих дочерних процессов.
5. После завершения каждого потомка родитель выводит его PID и код завершения.
6. Родительский процесс выводит сообщение о своём завершении.

### Команда для запуска
```bash
python3 src/fork.py
```

### Пример вывода
```
START
Parent(PID=11236)
Child_A(PID=11237, PPID=11236)
Child_B(PID=11238, PPID=11236)
Parent: Child_A (PID=11237) ended with code 0
Parent: Child_B (PID=11238) ended with code 0
Parent: END
```

## Задание 2: Поиск процессов

### Цель
Освоить использование утилит `ps` и `pstree` для поиска и анализа пользовательских процессов, а также научиться фильтровать их вывод для обнаружения короткоживущих процессов.

### Шаги выполнения
1. Написана программа `fork.py`, создающая два дочерних процесса.
2. Из-за быстрого завершения процессов (за миллисекунды) стандартные команды `ps` и `pstree` не отображали их.
3. Для решения проблемы применялись:
   - Анализ стандартного вывода команд.
   - Добавление задержек в программу.
   - Использование фильтров и ключей для поиска.
   - Запуск программы в фоновом режиме с немедленным анализом.

### Команды по умолчанию и их вывод
```bash
ps -ef --forest | head -n 30 | cat
```
```
UID          PID    PPID  C STIME TTY          TIME CMD
root           2       0  0 09:42 ?        00:00:00 [kthreadd]
root           3       2  0 09:42 ?        00:00:00  \_ [pool_workqueue_release]
root           4       2  0 09:42 ?        00:00:00  \_ [kworker/R-rcu_gp]
root           5       2  0 09:42 ?        00:00:00  \_ [kworker/R-sync_wq]
root           6       2  0 09:42 ?        00:00:00  \_ [kworker/R-kvfree_rcu_reclaim]
root           7       2  0 09:42 ?        00:00:00  \_ [kworker/R-slub_flushwq]
root           8       2  0 09:42 ?        00:00:00  \_ [kworker/R-netns]
root          10       2  0 09:42 ?        00:00:00  \_ [kworker/0:0H-events_highpri]
root          13       2  0 09:42 ?        00:00:00  \_ [kworker/R-mm_percpu_wq]
root          14       2  0 09:42 ?        00:00:00  \_ [rcu_tasks_kthread]
root          15       2  0 09:42 ?        00:00:00  \_ [rcu_tasks_rude_kthread]
root          16       2  0 09:42 ?        00:00:00  \_ [rcu_tasks_trace_kthread]
root          17       2  0 09:42 ?        00:00:00  \_ [ksoftirqd/0]
root          18       2  0 09:42 ?        00:00:03  \_ [rcu_preempt]
root          19       2  0 09:42 ?        00:00:00  \_ [rcu_exp_par_gp_kthread_worker/0]
root          20       2  0 09:42 ?        00:00:00  \_ [rcu_exp_gp_kthread_worker]
root          21       2  0 09:42 ?        00:00:00  \_ [migration/0]
root          22       2  0 09:42 ?        00:00:00  \_ [idle_inject/0]
root          23       2  0 09:42 ?        00:00:00  \_ [cpuhp/0]
root          24       2  0 09:42 ?        00:00:00  \_ [cpuhp/2]
root          25       2  0 09:42 ?        00:00:00  \_ [idle_inject/2]
root          26       2  0 09:42 ?        00:00:00  \_ [migration/2]
root          27       2  0 09:42 ?        00:00:00  \_ [ksoftirqd/2]
root          28       2  0 09:42 ?        00:00:00  \_ [kworker/2:0-events]
root          29       2  0 09:42 ?        00:00:00  \_ [kworker/2:0H-events_highpri]
root          30       2  0 09:42 ?        00:00:00  \_ [cpuhp/4]
root          31       2  0 09:42 ?        00:00:00  \_ [idle_inject/4]
root          32       2  0 09:42 ?        00:00:00  \_ [migration/4]
root          33       2  0 09:42 ?        00:00:00  \_ [ksoftirqd/4]
```

```bash
pstree -p | head -n 50 | cat
```
```
systemd(1)-+-ModemManager(1208)-+-{ModemManager}(1218)
           |                    |-{ModemManager}(1221)
           |                    `-{ModemManager}(1226)
           |-NetworkManager(1098)-+-{NetworkManager}(1131)
           |                      |-{NetworkManager}(1132)
           |                      `-{NetworkManager}(1133)
           |-accounts-daemon(1041)-+-{accounts-daemon}(1135)
           |                       |-{accounts-daemon}(1136)
           |                       `-{accounts-daemon}(1138)
           |-avahi-daemon(989)---avahi-daemon(1092)
           |-bluetoothd(991)
           |-colord(1538)-+-{colord}(1546)
           |              |-{colord}(1547)
           |              `-{colord}(1549)
           |-cron(1046)
           |-cups-browsed(2016)-+-{cups-browsed}(2024)
           |                    |-{cups-browsed}(2025)
           |                    `-{cups-browsed}(2026)
           |-cupsd(1340)
           |-dbus-daemon(992)
           |-fwupd(4986)-+-{fwupd}(4987)
           |             |-{fwupd}(4988)
           |             |-{fwupd}(4989)
           |             |-{fwupd}(4990)
           |             `-{fwupd}(4992)
           |-gdm3(1358)-+-gdm-session-wor(2053)-+-gdm-wayland-ses(2188)-+-gnome-session-b(2199)-+-{gnome-session-b}(2270)
           |            |                       |                       |                       |-{gnome-session-b}(2271)
           |            |                       |                       |                       `-{gnome-session-b}(2272)
           |            |                       |                       |-{gdm-wayland-ses}(2195)
           |            |                       |                       |-{gdm-wayland-ses}(2196)
           |            |                       |                       `-{gdm-wayland-ses}(2197)
           |            |                       |-{gdm-session-wor}(2054)
           |            |                       |-{gdm-session-wor}(2055)
           |            |                       `-{gdm-session-wor}(2056)
           |            |-{gdm3}(1360)
           |            |-{gdm3}(1361)
           |            `-{gdm3}(1362)
           |-gnome-remote-de(1000)-+-{gnome-remote-de}(1139)
           |                       |-{gnome-remote-de}(1143)
           |                       `-{gnome-remote-de}(1144)
           |-kerneloops(2018)
           |-kerneloops(2021)
           |-polkitd(1008)-+-{polkitd}(1188)
           |               |-{polkitd}(1189)
           |               `-{polkitd}(1190)
           |-power-profiles-(1016)-+-{power-profiles-}(1096)
           |                       |-{power-profiles-}(1097)
           |                       `-{power-profiles-}(1106)
           |-rsyslogd(1119)-+-{rsyslogd}(1128)
           |                |-{rsyslogd}(1129)
```

### Причины невозможности обнаружения процессов
- **Обрезка вывода**: Использование `head -n 30` и `head -n 50` ограничивает вывод первыми строками, где находятся системные процессы.
- **Приоритет системных процессов**: Системные процессы с меньшими PID отображаются в начале вывода.
- **Короткое время жизни**: Процессы `fork.py` завершаются за миллисекунды, не успевая попасть в вывод.
- **Отсутствие фильтрации**: Команды показывают все процессы системы, а не только пользовательские.

### Правильные команды и их вывод
#### Шаг 1: Запуск программы с задержкой в фоновом режиме
```bash
python3 src/fork.py &
```

#### Шаг 2: Поиск процессов с фильтрацией
```bash
ps -u $USER -o pid,ppid,comm,cmd --forest | grep python
```
```
5956    4512  |       \_ pyt  |       \_ python3 src/fork.py
5957    5956  |       |  pyt  |       |   \_ python3 src/fork.py
5958    5956  |       |  pyt  |       |   \_ python3 src/fork.py
5962    4512  |       \_ gre  |       \_ grep --color=auto python
```

```bash
pstree -p -s $$
```
```
systemd(1)───systemd(2068)───gnome-terminal-(4504)───bash(4512)─┬─pstree(5979)
                                                                └─python3(5975)─┬─python3(5976)
                                                                                └─python3(5977)
```

### Выводы
- **Важность фильтрации**: Без фильтров команды `ps` и `pstree` показывают системные процессы с меньшими PID, что затрудняет поиск пользовательских процессов.
- **Короткоживущие процессы**: Для их обнаружения необходимо:
  - Добавлять задержки в программу (`time.sleep()`).
  - Запускать программу в фоновом режиме (`&`).
  - Немедленно выполнять команды мониторинга.
- **Эффективные методы поиска**:
  - `ps -u $USER`: показывает только процессы текущего пользователя.
  - `grep python`: фильтрует процессы по имени.
  - `pstree -p -s $$`: отображает цепочку процессов от текущего shell.
  - `--forest`: визуализирует иерархию процессов.
- **Подтверждение работы программы**: Правильные команды подтвердили создание корректного дерева процессов с двумя дочерними процессами и правильными PPID.
- **Встраивание в систему**: Процессы пользователя являются частью общей иерархии, корнем которой является `systemd` (PID 1).

## Задание 3: Изучение `/proc`

### Цель
Изучить виртуальную файловую систему `/proc` для получения информации о процессах и состоянии ядра Linux. Научиться извлекать данные о текущем процессе по его PID.

### Шаги выполнения
1. Определить PID текущей командной оболочки (bash).
2. Исследовать содержимое ключевых файлов в директории `/proc/<PID>/`.
3. Проанализировать и объяснить назначение каждого файла.

### Команды и вывод
#### Шаг 1: Определение PID текущей оболочки
```bash
echo $$
```
```
4512
```

```bash
cat /proc/4512/cmdline | tr '\0' ' '; echo
```
```
bash
```

```bash
head -n 20 /proc/4512/status
```
```
Name:	bash
Umask:	0002
State:	S (sleeping)
Tgid:	4512
Ngid:	0
Pid:	4512
PPid:	4504
TracerPid:	0
Uid:	1000	1000	1000	1000
Gid:	1000	1000	1000	1000
FDSize:	256
Groups:	4 24 27 30 46 100 114 1000 
NStgid:	4512
NSpid:	4512
NSpgid:	4512
NSsid:	4512
Kthread:	0
VmPeak:	   20448 kB
VmSize:	   20448 kB
VmLck:	       0 kB
```

```bash
ls -l /proc/4512/fd
```
```
total 0
lrwx------ 1 discessit discessit 64 Sep 21 10:17 0 -> /dev/pts/0
lrwx------ 1 discessit discessit 64 Sep 21 10:17 1 -> /dev/pts/0
lrwx------ 1 discessit discessit 64 Sep 21 10:17 2 -> /dev/pts/0
lrwx------ 1 discessit discessit 64 Sep 21 10:17 255 -> /dev/pts/0
```

### Пояснение назначения файлов
1. **`/proc/<pid>/cmdline`**
   - **Назначение**: Содержит полную командную строку запуска процесса, включая аргументы.
   - **Особенности**: Аргументы разделены нулевыми символами (`\0`). Для читаемости используется `tr '\0' ' '`.
   - **Пример**: Для процесса `bash` выводится только `bash`, так как он запущен без аргументов.

2. **`/proc/<pid>/status`**
   - **Назначение**: Содержит информацию о состоянии процесса в читаемом формате.
   - **Ключевые поля**:
     - `Name`: имя исполняемого файла.
     - `State`: текущее состояние процесса (`S` = sleeping).
     - `Pid`: идентификатор процесса.
     - `PPid`: идентификатор родительского процесса (например, 4504 — терминал).
     - `Uid/Gid`: реальный, эффективный, сохранённый и файловый UID/GID.
     - `VmSize`: размер виртуальной памяти.

3. **`/proc/<pid>/fd/`**
   - **Назначение**: Директория с симлинками на открытые файлы процесса.
   - **Стандартные дескрипторы**:
     - `0`: stdin (стандартный ввод).
     - `1`: stdout (стандартный вывод).
     - `2`: stderr (стандартный вывод ошибок).
     - `255`: используется `bash` для дополнительных операций.
   - **Пример**: Все дескрипторы связаны с `/dev/pts/0` (псевдо-терминал).

### Выводы
- Файловая система `/proc` предоставляет динамическую информацию о процессах в реальном времени.
- Каждый процесс имеет свою директорию `/proc/<PID>/`, содержащую данные о состоянии, ресурсах и окружении.
- Ключевые файлы: `cmdline` (командная строка), `status` (статистика), `fd/` (файловые дескрипторы), `maps` (карта памяти), `environ` (переменные окружения).
- Навыки работы с `/proc` необходимы для системного администрирования и отладки приложений.

## Задание 4: Анализ процессов (нагрузка CPU/память/IO)

### Цель
Освоить мониторинг и анализ системной нагрузки с помощью утилит Linux, идентифицировать процессы, потребляющие CPU, память и выполняющие операции ввода-вывода.

### Команды и вывод
#### Моментальный срез нагрузки
```bash
top -b -n 1 | head -n 20
```
```
top - 10:31:41 up 49 min,  1 user,  load average: 0.28, 0.26, 0.40
Tasks: 317 total,   1 running, 316 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.8 us,  0.8 sy,  0.0 ni, 98.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st 
MiB Mem :  15717.3 total,  10738.0 free,   2639.5 used,   2934.5 buff/cache     
MiB Swap:   4096.0 total,   4096.0 free,      0.0 used.  13077.8 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
   3865 discess+  20   0 2912748 354548 123092 S   9.1   2.2   5:57.27 Isolate+
   6534 discess+  20   0   23168   5368   3448 R   9.1   0.0   0:00.02 top
      1 root      20   0   23660  14052   9188 S   0.0   0.1   0:03.96 systemd
      2 root      20   0       0      0      0 S   0.0   0.0   0:00.01 kthreadd
      3 root      20   0       0      0      0 S   0.0   0.0   0:00.00 pool_wo+
      4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
      5 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
      6 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
      7 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
      8 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
     10 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
     13 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
     14 root      20   0       0      0      0 I   0.0   0.0   0:00.00 rcu_tas+
```

```bash
ps -eo pid,ppid,comm,state,%cpu,%mem,etime --sort=-%cpu | head -n 15 | cat
```
```
    PID    PPID COMMAND         S %CPU %MEM     ELAPSED
   3865    3257 Isolated Web Co S 12.0  2.2       49:37
   3032    2338 firefox         S 11.2  4.4       49:42
   2338    2068 gnome-shell     S  9.0  2.0       49:50
   3505    3257 WebExtensions   S  1.9  1.4       49:38
   4521    2068 gnome-text-edit S  1.6  0.9       46:53
    270       2 irq/140-FTCS100 S  1.5  0.0       50:05
   3867    3257 Isolated Web Co S  1.1  1.3       49:37
   4504    2068 gnome-terminal- S  1.1  0.3       46:58
   6406    2338 gjs             S  0.3  0.4       02:59
   1035       1 snapd           S  0.3  0.2       50:02
   2507    2068 ibus-daemon     S  0.3  0.0       49:49
     18       2 rcu_preempt     I  0.2  0.0       50:06
   4417    2068 nautilus        S  0.2  1.1       48:12
   3280    3257 Privileged Cont S  0.2  0.8       49:39
```

```bash
ps -eo pid,ppid,comm,state,%cpu,%mem,rss --sort=-%mem | head -n 15 | cat
```
```
    PID    PPID COMMAND         S %CPU %MEM   RSS
   3032    2338 firefox         S 11.2  4.3 692736
   3865    3257 Isolated Web Co S 11.9  2.2 354692
   2338    2068 gnome-shell     S  9.1  2.0 332772
   3505    3257 WebExtensions   S  2.0  1.6 265436
   3867    3257 Isolated Web Co S  1.1  1.3 213800
   4417    2068 nautilus        S  0.2  1.1 186736
   4521    2068 gnome-text-edit S  1.6  0.9 160848
   3280    3257 Privileged Cont S  0.2  0.8 137208
   4599    3257 Web Content     S  0.0  0.4 72900
   4165    3257 Web Content     S  0.0  0.4 72684
   4656    3257 Web Content     S  0.0  0.4 72456
   6406    2338 gjs             S  0.3  0.4 65172
   4504    2068 gnome-terminal- S  1.1  0.3 64120
   2576    2306 evolution-alarm S  0.0  0.3 62268
```

```bash
pidstat -u -r -d 1 5
```
```
Linux 6.14.0-29-generic (discessit-MCLF-XX) 	09/21/2025 	_x86_64_	(12 CPU)

10:33:35 AM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
10:33:36 AM  1000      2085    0.00    0.98    0.00    0.00    0.98     6  pipewire
10:33:36 AM  1000      2338    0.98    0.00    0.00    0.00    0.98     8  gnome-shell
10:33:36 AM  1000      6599    0.98    0.98    0.00    0.00    1.96     2  pidstat

10:33:35 AM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
10:33:36 AM  1000      6599      2.94      0.00   19732    5004   0.03  pidstat

10:33:35 AM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command

10:33:36 AM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
10:33:37 AM     0        98    1.00    0.00    0.00    0.00    1.00     4  kcompactd0
10:33:37 AM     0       946    0.00    1.00    0.00    0.00    1.00     8  irq/169-AudioDSP
10:33:37 AM  1000      3032    1.00    0.00    0.00    0.00    1.00     2  firefox
10:33:37 AM  1000      3865    1.00    0.00    0.00    0.00    1.00     4  Isolated Web Co
10:33:37 AM  1000      4504    1.00    0.00    0.00    0.00    1.00     2  gnome-terminal-
10:33:37 AM  1000      6599    0.00    1.00    0.00    0.00    1.00     2  pidstat

10:33:36 AM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
10:33:37 AM  1000      2085      0.00      0.00  125820   15028   0.09  pipewire
10:33:37 AM  1000      2089      1.00      0.00  414720   17244   0.11  wireplumber
10:33:37 AM  1000      3865      1.00      0.00 2912748  354992   2.21  Isolated Web Co
10:33:37 AM  1000      4349      2.00      0.00  577444   32376   0.20  update-notifier

10:33:36 AM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command

10:33:37 AM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
10:33:38 AM     0        28    0.00    1.00    0.00    0.00    1.00     2  kworker/2:0-mm_percpu_wq
10:33:38 AM  1000      2338    1.00    1.00    0.00    0.00    2.00     6  gnome-shell
10:33:38 AM  1000      4504    1.00    0.00    0.00    0.00    1.00     2  gnome-terminal-
10:33:38 AM  1000      6599    1.00    1.00    0.00    0.00    2.00     2  pidstat

10:33:37 AM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
10:33:38 AM  1000      3865      1.00      0.00 2912748  354992   2.21  Isolated Web Co

10:33:37 AM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command

10:33:38 AM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
10:33:39 AM     0        18    0.00    1.00    0.00    0.00    1.00     0  rcu_preempt
10:33:39 AM   990       783    1.00    0.00    0.00    0.00    1.00     6  systemd-oomd
10:33:39 AM  1000      2338    1.00    0.00    0.00    0.00    1.00     4  gnome-shell
10:33:39 AM  1000      3280    1.00    1.00    0.00    0.00    2.00     1  Privileged Cont
10:33:39 AM  1000      3505    2.00    1.00    0.00    0.00    3.00     4  WebExtensions
10:33:39 AM  1000      6599    0.00    1.00    0.00    0.00    1.00     2  pidstat

10:33:38 AM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
10:33:39 AM  1000      3505      7.00      0.00 2723464  234660   1.46  WebExtensions

10:33:38 AM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command

10:33:39 AM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
10:33:40 AM     0       583    0.00    1.00    0.00    0.00    1.00     8  kworker/u49:1-i915_flip
10:33:40 AM  1000      2338    1.00    1.00    0.00    0.00    2.00     6  gnome-shell
10:33:40 AM  1000      4504    1.00    1.00    0.00    0.00    2.00     2  gnome-terminal-
10:33:40 AM  1000      6599    1.00    1.00    0.00    0.00    2.00     2  pidstat

10:33:39 AM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command

10:33:39 AM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command

Average:      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
Average:        0        18    0.00    0.20    0.00    0.00    0.20     -  rcu_preempt
Average:        0        28    0.00    0.20    0.00    0.00    0.20     -  kworker/2:0-events_freezable
Average:        0        98    0.20    0.00    0.00    0.00    0.20     -  kcompactd0
Average:        0       583    0.00    0.20    0.00    0.00    0.20     -  kworker/u49:1-i915_flip
Average:      990       783    0.20    0.00    0.00    0.00    0.20     -  systemd-oomd
Average:        0       946    0.00    0.20    0.00    0.00    0.20     -  irq/169-AudioDSP
Average:     1000      2085    0.00    0.20    0.00    0.00    0.20     -  pipewire
Average:     1000      2338    0.80    0.40    0.00    0.00    1.20     -  gnome-shell
Average:     1000      3032    0.20    0.00    0.00    0.00    0.20     -  firefox
Average:     1000      3280    0.20    0.20    0.00    0.00    0.40     -  Privileged Cont
Average:     1000      3505    0.40    0.20    0.00    0.00    0.60     -  WebExtensions
Average:     1000      3865    0.20    0.00    0.00    0.00    0.20     -  Isolated Web Co
Average:     1000      4504    0.60    0.20    0.00    0.00    0.80     -  gnome-terminal-
Average:     1000      6599    0.60    1.00    0.00    0.00    1.59     -  pidstat

Average:      UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
Average:     1000      2085      0.00      0.00  125834   15028   0.09  pipewire
Average:     1000      2089      0.20      0.00  414720   17244   0.11  wireplumber
Average:     1000      3505      1.39      0.00 2723454  234809   1.46  WebExtensions
Average:     1000      3865      0.40      0.00 2912748  354992   2.21  Isolated Web Co
Average:     1000      4349      0.40      0.00  577444   32376   0.20  update-notifier
Average:     1000      6599      0.60      0.00   19732    5004   0.03  pidstat

Average:      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
```

```bash
sudo iotop -b -n 3 | head -n 15
```
```
Total DISK READ:         4.30 K/s | Total DISK WRITE:         4.97 K/s
Current DISK READ:       0.00 B/s | Current DISK WRITE:       0.00 B/s
    TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN      IO    COMMAND
      1 be/4 root        0.00 B/s    0.00 B/s ?unavailable?  init splash
      2 be/4 root        0.00 B/s    0.00 B/s ?unavailable?  [kthreadd]
      3 be/4 root        0.00 B/s    0.00 B/s ?unavailable?  [pool_workqueue_release]
      4 be/0 root        0.00 B/s    0.00 B/s ?unavailable?  [kworker/R-rcu_gp]
      5 be/0 root        0.00 B/s    0.00 B/s ?unavailable?  [kworker/R-sync_wq]
      6 be/0 root        0.00 B/s    0.00 B/s ?unavailable?  [kworker/R-kvfree_rcu_reclaim]
      7 be/0 root        0.00 B/s    0.00 B/s ?unavailable?  [kworker/R-slub_flushwq]
      8 be/0 root        0.00 B/s    0.00 B/s ?unavailable?  [kworker/R-netns]
     10 be/0 root        0.00 B/s    0.00 B/s ?unavailable?  [kworker/0:0H-events_highpri]
     13 be/0 root        0.00 B/s    0.00 B/s ?unavailable?  [kworker/R-mm_percpu_wq]
     14 be/4 root        0.00 B/s    0.00 B/s ?unavailable?  [rcu_tasks_kthread]
     15 be/4 root        0.00 B/s    0.00 B/s ?unavailable?  [rcu_tasks_rude_kthread]
```

### Выводы
#### TOP-5 по CPU
| PID  | COMMAND          | %CPU | ELAPSED | Причина нагрузки                         |
|------|------------------|------|---------|------------------------------------------|
| 3865 | Isolated Web Co  | 12.0 | 49:37   | Компонент браузера (вероятно Firefox)    |
| 3032 | firefox          | 11.2 | 49:42   | Основной процесс браузера Firefox        |
| 2338 | gnome-shell      | 9.0  | 49:50   | Графическая оболочка GNOME              |
| 3505 | WebExtensions    | 1.9  | 49:38   | Процесс расширений браузера              |
| 4521 | gnome-text-edit  | 1.6  | 46:53   | Текстовый редактор GNOME                |

#### TOP-5 по памяти
| PID  | COMMAND          | %MEM | Причина использования памяти             |
|------|------------------|------|-----------------------------------------|
| 3032 | firefox          | 4.4  | Основной процесс браузера с вкладками    |
| 3865 | Isolated Web Co  | 2.2  | Изолированный веб-контент браузера       |
| 2338 | gnome-shell      | 2.0  | Графическая оболочка GNOME              |
| 3505 | WebExtensions    | 1.4  | Расширения браузера                     |
| 4417 | nautilus         | 1.1  | Файловый менеджер GNOME                 |

#### Анализ IO нагрузки
- **Общая статистика**:
  - READ: 4.30 K/s (минимальная нагрузка на чтение).
  - WRITE: 4.97 K/s (минимальная нагрузка на запись).
  - Текущая активность: 0.00 B/s (активность отсутствовала).
- **Основной потребитель ресурсов**: Браузер Firefox и его компоненты:
  - Основной процесс: 11.2% CPU, 4.4% памяти.
  - Изолированные веб-процессы: до 12.0% CPU.
  - Процессы расширений: 1.9% CPU.
- **Графическая среда**: GNOME Shell потребляет 9.0% CPU и 2.0% памяти, что нормально для GUI.
- **Характер нагрузки**: Преимущественно CPU-ориентированная, без интенсивных операций ввода-вывода.
- **Низкая IO нагрузка**: Минимальная дисковая активность (4-5 KB/s).

## Задание 5: Мини-утилита `ptree`

### Цель
Разработать утилиту, отображающую цепочку родительских процессов от текущего процесса до корневого (`systemd` с PID 1). Освоить чтение информации о процессах из `/proc`.

### Принцип работы
1. **Чтение информации**: Утилита читает файлы `/proc/<pid>/status` для каждого процесса в цепочке.
2. **Извлечение данных**:
   - Имя процесса (`Name`).
   - PID родительского процесса (`PPid`).
3. **Построение цепочки**: Программа движется от указанного PID до PID 1.
4. **Форматирование вывода**: Цепочка отображается в формате `имя(PID) ← имя(PID) ← ...`.

### Команды для запуска
#### Для текущего процесса
```bash
python3 src/pstree.py
```

#### Для указанного PID
```bash
python3 src/pstree.py 2272
```
```
gdbus(2272) ← gdm-wayland-ses(2188) ← gdm-session-wor(2053) ← gdm3(1358) ← systemd(1)
```

### Выводы
- Файловая система `/proc` предоставляет всю необходимую информацию для анализа иерархии процессов.
- Чтение `PPid` из `/proc/<pid>/status` — надёжный способ определения родительских связей.
- Рекурсивный обход от потомка к предкам позволяет построить полную цепочку до `systemd`.
- Утилита успешно отображает иерархию процессов в удобочитаемом формате.

## Ответы на вопросы

1. **Чем процесс отличается от программы?**  
   Программа — это файл на диске. Программа становится процессом, если запустить выполнение программы.

2. **Что будет, если вызвать `fork()` без `wait()`?**  
   Родительский процесс продолжит работу, не дожидаясь завершения дочернего. После завершения дочернего процесса он станет зомби (будет мёртвым, но запись о нём останется).

3. **Как система хранит информацию о процессах?**  
   В Linux информация о процессах хранится в таблице процессов. Для каждого процесса хранится: PID, PPID, состояние процесса, указатели на память процесса, информация об открытых файлах, приоритеты и права доступа. В файловой системе `/proc` эта информация представлена в виде файлов.

4. **Что делает `exec()` и зачем он нужен?**  
   `exec()` заменяет текущий выполняемый процесс новой программой, но не создаёт новый процесс. Процесс сохраняет тот же PID, PPID, открытые файлы, приоритеты и другое. Это позволяет любой программе запускать другие программы, как если бы пользователь делал это из командной строки. Сочетание `fork()` + `exec()` позволяет создавать конвейеры и комбинировать специализированные утилиты. `fork()` создаёт копию процесса быстро, а `exec()` заменяет её нужной программой — это быстрее и проще, чем создание нового процесса.

5. **Почему в `/proc` нет «настоящих» файлов?**  
   Потому что `/proc` — это виртуальная файловая система. Эти "файлы" не лежат на диске — они создаются ядром на ходу, когда вы их читаете. Это удобный интерфейс для получения информации о системе и процессах.

6. **Как интерпретировать поля `top`: `%CPU`, `%MEM`, `VIRT`, `RES`, `SHR`, `TIME+`?**  
   - `%CPU` — сколько процентов времени CPU занято этим процессом.  
   - `%MEM` — какой процент всей оперативной памяти использует процесс.  
   - `VIRT` — вся виртуальная память процесса.  
   - `RES` — реальная физическая память, которую процесс использует прямо сейчас.  
   - `SHR` — сколько из `RES` может быть использовано другими процессами (общие библиотеки).  
   - `TIME+` — общее время работы процесса на CPU.

7. **Почему сумма `%CPU` может быть больше 100%?**  
   Потому что `%CPU` показывает загрузку одного ядра. Если система многоядерная, каждое ядро может быть загружено на 100%, и суммарно получится больше 100%. Например, если один процесс грузит все 6 ядер на 100%, он покажет 600% CPU.

8. **Чем отличается мгновенное `%CPU` от `load average`? Что означает строка `Cpu(s)` в `top` (в т.ч. `wa`)?**  
   - `%CPU` — мгновенная загрузка процессора прямо сейчас.  
   - `Load average` — средняя нагрузка за 1, 5 и 15 минут, показывает, сколько процессов в среднем ждало CPU.  
   - **Строка `Cpu(s)` в `top`**:  
     - `us` — время в пользовательских процессах.  
     - `sy` — время в системных вызовах ядра.  
     - `ni` — время в процессах с изменённым приоритетом (`nice`).  
     - `id` — время простоя.  
     - `wa` — I/O wait, процент времени, когда CPU простаивал в ожидании операций ввода-вывода.  
     - `hi` — время обработки аппаратных прерываний.  
     - `si` — время обработки программных прерываний.  
     - `st` — steal time, время, украденное гипервизором.

9. **Чем IO-нагрузка отличается от CPU-нагрузки и как её увидеть (`pidstat -d`, `iotop`, `/proc/<pid>/io`)?**  
   - **CPU-нагрузка**: процессор занят вычислениями.  
   - **IO-нагрузка**: процессор ждёт завершения операций диска или сети.  
   - **Как увидеть IO-нагрузку**:  
     - `pidstat -d` — показывает IO по процессам.  
     - `iotop` — мониторинг дискового IO в стиле `top`.  
     - `/proc/<pid>/io` — детальная статистика IO для конкретного процесса.

10. **Что такое `nice`/приоритеты процессов и как они влияют на планирование?**  
    `nice` — это уровень "вежливости" процесса (от -20 до 19). Чем выше `nice`, тем ниже приоритет процесса, и тем реже он получает CPU. Процессы с низким `nice` (отрицательным) получают CPU чаще. Планировщик использует `nice` для распределения времени CPU между процессами.

11. **Чем поток отличается от процесса и как увидеть потоки в `ps`/`top`?**  
    - **Процесс** — выполняемая программа.  
    - **Поток** — часть процесса, которая делит с ним память, но выполняется параллельно.  
    - **Как увидеть потоки**:  
      - `top -H` — показывает потоки вместо процессов.  
      - `ps -eLf` — отображает все потоки системы.  
      - В `pstree` потоки отображаются в фигурных скобках: `{process_name}`.

12. **Что такое зомби и сироты, как они возникают и куда «деваются»?**  
    - **Зомби** — мёртвые процессы, завершившиеся, но их родитель ещё не прочитал статус выхода. Они остаются в системе, пока родитель не вызовет `wait()` или не завершится сам.  
    - **Сироты** — процессы, у которых умер родитель. Их усыновляет процесс `init` (PID 1), который становится их новым родителем и забирает их статусы.  
    - **Куда деваются**: `init` периодически вызывает `wait()` для всех своих детей, поэтому сироты не становятся зомби и нормально убираются из системы.
