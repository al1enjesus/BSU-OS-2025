Лабораторная работа 2 — Процессы и файловая система /proc

Цель работы:
Понять модель процессов Linux, принципы порождения и ожидания завершения, а также научиться извлекать информацию из `/proc`.

Ход работы

1. Создание процессов
Реализована программа на Python, создающая два дочерних процесса:

Код программы: src/fork_example.py.

Запуск программы:
```bash
python src/fork_example.py
```

Результат:
```txt
parent: PID=56963
child2: PID=56965, PPID=56963
child1: PID=56964, PPID=56963
parent: children exited
```

Вывод: Программа успешно создала два дочерних процесса. Каждый дочерний процесс вывел свой PID и PPID (идентификатор родительского процесса). Родительский процесс дождался завершения обоих дочерних процессов и вывел сообщение об этом.


2. Исследование дерева процессов
Выполнены команды для анализа дерева процессов:

Команда:
```bash
ps -ef --forest | head -n 30
```

Результат(только первые строчки, но уже видно как работает дерево процессов)
```txt
UID          PID    PPID  C STIME TTY          TIME CMD
root           2       0  0 Sep19 ?        00:00:00 [kthreadd]
root           3       2  0 Sep19 ?        00:00:00  \_ [pool_workqueue_release]
root           4       2  0 Sep19 ?        00:00:00  \_ [kworker/R-rcu_gp]
root           5       2  0 Sep19 ?        00:00:00  \_ [kworker/R-sync_wq]
```

Команда:
```bash
pstree -p | head -n 50
```

Результат(только первые строчки, так как оставшиеся имеют такую же структуру):
```txt
systemd(1)-+-NetworkManager(704)-+-{NetworkManager}(710)
           |                     |-{NetworkManager}(711)
           |                     `-{NetworkManager}(712)
           |-containerd(823)-+-{containerd}(843)
           |                 |-{containerd}(845)
           |                 |-{containerd}(846)
           |                 |-{containerd}(847)
           |                 |-{containerd}(848)
           |                 |-{containerd}(849)
           |                 |-{containerd}(850)
           |                 |-{containerd}(851)
           |                 |-{containerd}(852)
           |                 |-{containerd}(853)
           |                 |-{containerd}(854)
           |                 `-{containerd}(877)
           |-dbus-broker-lau(619)---dbus-broker(620)
           |-dockerd(879)-+-{dockerd}(880)
           |              |-{dockerd}(881)

```

Вывод: Команды ps -ef --forest и pstree -p показывают иерархию процессов в системе. Видно, что все процессы являются потомками systemd (PID=1). Команда pstree отображает дерево процессов в более наглядном виде, показывая также потоки (в фигурных скобках).

3. Изучение /proc
Исследованы файлы в `/proc` для текущей оболочки:

Команда:
```bash
echo $$
```
Результат:

```txt
57481
```

Команда:
```bash
cat /proc/$$/cmdline | tr '\0' ' '; echo
```

```txt
-zsh
```

Команда:
```bash
head -n 20 /proc/$$/status
```

Результат:
```txt
Name:   zsh
Umask:  0022
State:  S (sleeping)
Tgid:   57481
Ngid:   0
Pid:    57481
PPid:   3040
TracerPid:      0
Uid:    1000    1000    1000    1000
Gid:    1000    1000    1000    1000
FDSize: 64
Groups: 968 994 998 1000
NStgid: 57481
NSpid:  57481
NSpgid: 57481
NSsid:  57481
Kthread:        0
VmPeak:    18168 kB
VmSize:    14652 kB
VmLck:         0 kB
```

Команда:
```bash
ls -l /proc/$$/fd
```

Результат:
```txt
total 0
lrwx------ 1 sinsenti sinsenti 64 Sep 21 16:16 0 -> /dev/pts/5
lrwx------ 1 sinsenti sinsenti 64 Sep 21 16:22 1 -> /dev/pts/5
lrwx------ 1 sinsenti sinsenti 64 Sep 21 16:22 10 -> /dev/pts/5
l-wx------ 1 sinsenti sinsenti 64 Sep 21 16:16 11 -> '/tmp/gitstatus.POWERLEVEL9K.1000.57481.1758460560.1.fifo (deleted)'
lr-x------ 1 sinsenti sinsenti 64 Sep 21 16:16 12 -> 'pipe:[165123]'
l-wx------ 1 sinsenti sinsenti 64 Sep 21 16:22 13 -> '/tmp/p10k.worker.1000.57481.1758460561.fifo (deleted)'
lr-x------ 1 sinsenti sinsenti 64 Sep 21 16:22 15 -> 'pipe:[165093]'
lrwx------ 1 sinsenti sinsenti 64 Sep 21 16:22 2 -> /dev/pts/5
```

Вывод:
- Команда echo $$ показала PID текущей оболочки (zsh) - 57481.
- Файл cmdline содержит командную строку запуска процесса, в данном случае -zsh.
- Файл status содержит подробную информацию о процессе: имя, состояние, идентификаторы, права доступа, информацию о памяти и т.д.
- В каталоге fd находятся симлинки на файлы, открытые процессом. Видно, что стандартные потоки ввода, вывода и ошибок (0, 1, 2) связаны с терминалом (/dev/pts/5). Также есть несколько именованных каналов (pipe) и удаленных файлов (deleted), которые были открыты процессом.

4. Анализ процессов (нагрузка CPU/память/IO)

Команда для анализа CPU:
```bash
ps -eo pid,ppid,comm,state,%cpu,%mem,etime --sort=-%cpu | head -n 15
```

Результат:
```txt
    PID    PPID COMMAND         S %CPU %MEM     ELAPSED
  54294   54153 VirtualBoxVM    S 92.9 22.0       26:08
  53516   25377 Isolated Web Co S  8.3  3.0       30:42
  55410   55409 nvim            S  3.2  0.6       15:52
  58048   55410 marksman        S  1.2  0.8       07:20
  53074   25377 Isolated Web Co S  0.8  2.1       32:14
  54153    1205 VBoxSVC         S  0.6  0.2       27:22
  54138    1205 VirtualBox      S  0.6  0.8       27:22
  57481    3040 zsh             S  0.6  0.0       09:52
  50818   25377 Isolated Web Co S  0.5  2.4       39:49
  53445   25377 Isolated Web Co S  0.4  1.9       30:43
   1292    1205 Hyprland        S  0.4  1.8  2-08:07:02
  25275    1205 firefox         S  0.4  5.4  2-04:43:23
  49968   25377 Isolated Web Co S  0.2  2.8    04:28:41
  56447   55410 node            S  0.1  0.6       13:15
```

Команда для анализа памяти:
```bash
ps -eo pid,ppid,comm,state,%cpu,%mem,rss --sort=-%mem | head -n 15
```

```txt
    PID    PPID COMMAND         S %CPU %MEM   RSS
  54294   54153 VirtualBoxVM    S 91.3 22.0 3438324
   9529    1205 64gram-desktop  S  0.1  5.9 933048
  25275    1205 firefox         S  0.4  5.4 846948
  53516   25377 Isolated Web Co S  8.2  3.0 471224
  25451   25377 WebExtensions   S  0.0  2.9 467180
  49968   25377 Isolated Web Co S  0.2  2.8 437972
  50818   25377 Isolated Web Co S  0.5  2.3 368136
  53074   25377 Isolated Web Co S  0.8  2.1 338420
  53445   25377 Isolated Web Co S  0.4  1.9 301324
   1292    1205 Hyprland        S  0.4  1.8 280544
   1928    1205 kitty           S  0.0  1.4 228524
  25408   25377 RDD Process     S  0.0  1.4 222152
  53363   25377 Isolated Web Co S  0.0  1.1 183120
   1409    1292 Xwayland        S  0.0  1.1 177640
```

Команда для мониторинга:
```bash
pidstat -u -r -d 1 5
```

```txt
Linux 6.15.9-arch1-1 (arch)     09/21/2025      _x86_64_        (8 CPU)

04:29:22 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
04:29:23 PM  1000      1292    5.94    1.98    0.00    0.00    7.92     5  Hyprland
04:29:23 PM  1000      1928    0.00    0.99    0.00    0.00    0.99     1  kitty
04:29:23 PM  1000     55410    1.98    0.00    0.00    0.00    1.98     2  nvim

04:29:22 PM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
04:29:23 PM  1000      1495    443.56      0.00 1438560   69032   0.44  waybar
04:29:23 PM  1000     60117      0.99      0.00    8252    6392   0.04  pidstat

04:29:22 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command

04:29:23 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
04:29:24 PM     0        16    0.00    1.00    0.00    0.00    1.00     2  rcu_preempt
04:29:24 PM  1000      1292    5.00    2.00    0.00    0.00    7.00     0  Hyprland
04:29:24 PM  1000      1495    0.00    1.00    0.00    0.00    1.00     6  waybar
04:29:24 PM     0     55034    0.00    1.00    0.00    0.00    1.00     2  kworker/u32:0+events_unbound
04:29:24 PM  1000     55410    1.00    0.00    0.00    0.00    1.00     6  nvim
04:29:24 PM  1000     60040    1.00    0.00    0.00    0.00    1.00     3  Web Content
04:29:24 PM  1000     60117    0.00    1.00    0.00    0.00    1.00     7  pidstat

04:29:23 PM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
04:29:24 PM  1000      1495    431.00      0.00 1438560   69032   0.44  waybar
04:29:24 PM  1000      3540      5.00      0.00   14436   11644   0.07  zsh
04:29:24 PM  1000     53074      1.00      0.00 2936264  379136   2.43  Isolated Web Co

04:29:23 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
04:29:24 PM  1000     25275      0.00      4.00      0.00       0  firefox

04:29:24 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
04:29:25 PM  1000      1292    4.00    4.00    0.00    0.00    8.00     0  Hyprland
04:29:25 PM  1000      1495    1.00    0.00    0.00    0.00    1.00     6  waybar
04:29:25 PM  1000      3040    1.00    0.00    0.00    0.00    1.00     2  tmux: server
04:29:25 PM     0     55034    0.00    2.00    0.00    0.00    2.00     4  kworker/u32:0+events_unbound
04:29:25 PM  1000     55410    1.00    0.00    0.00    1.00    1.00     2  nvim
04:29:25 PM  1000     60117    0.00    2.00    0.00    0.00    2.00     7  pidstat

04:29:24 PM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
04:29:25 PM  1000      1495    445.00      0.00 1438560   69032   0.44  waybar
04:29:25 PM  1000      3593      5.00      0.00   14664   12016   0.08  zsh
04:29:25 PM  1000      4432      5.00      0.00   14460   12092   0.08  zsh

04:29:24 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
04:29:25 PM  1000     25275      0.00      4.00      0.00       0  firefox

04:29:25 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
04:29:26 PM  1000      1292    5.00    3.00    0.00    0.00    8.00     0  Hyprland
04:29:26 PM  1000      1495    0.00    1.00    0.00    0.00    1.00     6  waybar
04:29:26 PM  1000      1928    1.00    0.00    0.00    0.00    1.00     1  kitty
04:29:26 PM     0     50335    0.00    1.00    0.00    0.00    1.00     4  kworker/u32:10-events_unbound
04:29:26 PM  1000     55410    2.00    0.00    0.00    0.00    2.00     6  nvim
04:29:26 PM     0     56506    0.00    1.00    0.00    0.00    1.00     3  kworker/u32:3+events_unbound
04:29:26 PM  1000     60117    0.00    1.00    0.00    0.00    1.00     7  pidstat

04:29:25 PM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
04:29:26 PM  1000      1495    430.00      0.00 1438560   69032   0.44  waybar

04:29:25 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command

04:29:26 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
04:29:27 PM     0        16    0.00    1.00    0.00    0.00    1.00     2  rcu_preempt
04:29:27 PM  1000      1292    6.00    2.00    0.00    0.00    8.00     6  Hyprland
04:29:27 PM  1000      1495    0.00    1.00    0.00    0.00    1.00     4  waybar
04:29:27 PM  1000     53074    1.00    0.00    0.00    0.00    1.00     2  Isolated Web Co
04:29:27 PM  1000     55410    2.00    1.00    0.00    0.00    3.00     2  nvim
04:29:27 PM     0     56506    0.00    1.00    0.00    0.00    1.00     3  kworker/u32:3-gfx_0.1.0
04:29:27 PM  1000     60117    1.00    1.00    0.00    0.00    2.00     7  pidstat

04:29:26 PM   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
04:29:27 PM  1000      1495    445.00      0.00 1438560   69032   0.44  waybar
04:29:27 PM  1000     25451      1.00      0.00 20005788  471796   3.03  WebExtensions
04:29:27 PM  1000     53074      1.00      0.00 2936264  378640   2.43  Isolated Web Co

04:29:26 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command

Average:      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
Average:        0        16    0.00    0.40    0.00    0.00    0.40     -  rcu_preempt
Average:     1000      1292    5.19    2.59    0.00    0.00    7.78     -  Hyprland
Average:     1000      1495    0.20    0.60    0.00    0.00    0.80     -  waybar
Average:     1000      1928    0.20    0.20    0.00    0.00    0.40     -  kitty
Average:     1000      3040    0.20    0.00    0.00    0.00    0.20     -  tmux: server
Average:        0     50335    0.00    0.20    0.00    0.00    0.20     -  kworker/u32:10+events_unbound
Average:     1000     53074    0.20    0.00    0.00    0.00    0.20     -  Isolated Web Co
Average:        0     55034    0.00    0.60    0.00    0.00    0.60     -  kworker/u32:0-gfx_0.1.0
Average:     1000     55410    1.60    0.20    0.00    0.20    1.80     -  nvim
Average:        0     56506    0.00    0.40    0.00    0.00    0.40     -  kworker/u32:3-gfx_0.1.0
Average:     1000     60040    0.20    0.00    0.00    0.00    0.20     -  Web Content
Average:     1000     60117    0.20    1.00    0.00    0.00    1.20     -  pidstat

Average:      UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
Average:     1000      1495    438.92      0.00 1438560   69032   0.44  waybar
Average:     1000      3540      1.00      0.00   14436   11644   0.07  zsh
Average:     1000      3593      1.00      0.00   14664   12016   0.08  zsh
Average:     1000      4432      1.00      0.00   14460   12092   0.08  zsh
Average:     1000     25451      0.20      0.00 20005788  471796   3.03  WebExtensions
Average:     1000     53074      0.40      0.00 2936264  379037   2.43  Isolated Web Co
Average:     1000     60117      0.20      0.00    8252    6392   0.04  pidstat

Average:      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
Average:     1000     25275      0.00      1.60      0.00       0  firefox
```

Вывод
- Топ процессов по CPU: Видно, что наибольшую нагрузку на CPU создает процесс VirtualBoxVM, затем Isolated Web Co и nvim.
- Топ процессов по памяти: VirtualBoxVM использует 22% памяти, затем 64gram-desktop и firefox.
- Мониторинг с pidstat: Позволяет увидеть нагрузку в динамике. Заметно, что процесс имеет высокое количество minor faults, что связано с обновлением интерфейса. Процесс firefox производит запись на диск (1.6 kB/s в среднем).


5. Мини-утилита ptree

Реализована утилита для отображения цепочки родительских процессов:

Код программы в src/ptree.py

Результат выполнения:
```txt
python(61313) ← zsh(57481) ← tmux: server(3040) ← systemd(1205) ← systemd(1)
```

Вывод: Утилита успешно отобразила цепочку родительских процессов от текущего (python) до systemd (PID=1). Видно, что процесс python был запущен из zsh, который в свою очередь был запущен из tmux, а tmux — из systemd (сессия пользователя).

6. Ответы на вопросы

1. Чем процесс отличается от программы?
   Программа - статичный исполняемый файл, процесс - экземпляр выполняющейся программы с собственным контекстом.

2. Что будет, если вызвать `fork()` без `wait()`?
   Дочерние процессы станут "зомби" после завершения, пока родитель не прочитает их статус.

3. Как система хранит информацию о процессах?
   В структурах данных ядра и виртуальной файловой системе `/proc`.

4. Что делает `exec()` и зачем он нужен?
   Заменяет текущий образ процесса новым. Нужен для запуска других программ.

5. Почему в `/proc` нет «настоящих» файлов?
   Это виртуальная ФС, предоставляющая интерфейс к данным ядра.

6. Как интерпретировать поля `top`?
   - `%CPU`: Использование CPU процессом
   - `%MEM`: Процент физической памяти
   - `VIRT`: Вся виртуальная память
   - `RES`: резидентная память
   - `SHR`: разделяемая память
   - `TIME+`: общее время CPU

7. Почему сумма `%CPU` может быть больше 100%?
CPU в top — это использование одного ядра CPU. Если процесс будет использовать более 1 ядра, то сумма будет больше 100%.

8. Чем мгновенное `%CPU` отличается от `load average`?
   `%CPU` - текущее использование, `load average` - средняя нагрузка за периоды (1, 5, 15 минут).
   `wa` в `top` показывает время ожидания I/O.

9. Как увидеть IO-нагрузку?
   Команды `pidstat -d`, `iotop` или чтение `/proc/<pid>/io`.

10. Что такое `nice`/приоритеты процессов?
    Значение nice влияет на приоритет планирования: более высокое значение nice означает более низкий приоритет.

11. Чем поток отличается от процесса?
    Потоки разделяют память и ресурсы процесса, а процессы изолированы. В `ps` потоки видны с опцией `-L`.

12. Что такое зомби и сироты?
    Зомби - завершенные процессы, чей статус не прочитан. Сироты - процессы, чей родитель завершился; их усыновляет init.

Помощь ИИ:
Помощь с объяснением, что полностью значат все команды и как они работают. Помощь в написании ответов на вопросы и объяснение более подробно их.

Заключение
В ходе работы изучены механизмы создания процессов, работы с файловой системой /proc и анализа системной нагрузки. Полученные навыки позволяют эффективно управлять процессами в Linux. Так же проведен анализ результатов команд.

Что использовалось:
1. Arch Linux
