# Лабораторная работа 1: Анализ системных логов

**Студент**: Топчеева Таисия  
**Группа**: 9 группа, 1 подгруппа  
**Дата**: 14 сентября 2025 г.

## Цель работы
Освоить базовые инструменты командной строки Linux для анализа системных логов (`/var/log/syslog`, `/var/log/auth.log`, `/var/log/dpkg.log`):
- Подсчёт самых частых слов в `syslog`.
- Анализ попыток входа в `auth.log` (SSH-попытки с IP или альтернативные метрики: имена пользователей, статусы, время).
- Подсчёт установленных пакетов в `dpkg.log`.
- При отсутствии логов использовать дамп `dmesg`.

## Окружение
- **Операционная система**: Ubuntu 25.04 (Plucky), виртуальная машина.
- **Логи**: Доступны `/var/log/syslog`, `/var/log/auth.log`, `/var/log/dpkg.log`. Размеры подтверждены командой:
  ```bash
  ls -lh /var/log/syslog /var/log/auth.log /var/log/dpkg.log
  ```
  **Вывод**:
  ```
  -rw-r----- 1 syslog adm   9,2K сен 14 17:06 /var/log/auth.log
  -rw-r--r-- 1 root   root 1017K сен 14 15:04 /var/log/dpkg.log
  -rw-r----- 1 syslog adm   376K сен 14 17:06 /var/log/syslog
  ```
- **Инструменты**: Bash, `cat`, `grep`, `awk`, `sed`, `sort`, `uniq`, `tr`, `head`, `cut`, `lsb_release`, `ls`, `systemctl`, `mkdir`.
- **Примечание**: Работа выполнена на виртуальной машине. SSH-сервер не установлен (`sshd.service` не найден). Лог `/var/log/auth.log` (9.2K) содержит минимальную активность: одна запись `Failed`, связанная с системной ошибкой активации сервиса `org.bluez` (Bluetooth), а не с аутентификацией. Успешные входы (`Accepted`) и несуществующие пользователи (`Invalid`) отсутствуют. Лог `/var/log/dpkg.log` (1017K) содержит записи об установке пакетов с низкой частотой (каждый пакет установлен один раз). Папка `logs/` создана для возможных дополнительных файлов.

## Задание А: Частотный анализ слов в syslog (TOP-5)

**Цель**: Подсчитать 5 самых частых "слов" (алфанумерических токенов) в `/var/log/syslog`, нормализовав регистр.

**Команда**:
```bash
cat /var/log/syslog \
  | tr -cs '[:alnum:]' '\n' \
  | tr '[:upper:]' '[:lower:]' \
  | sort \
  | uniq -c \
  | sort -nr \
  | head -n 5
```

**Пояснения**:
- `cat /var/log/syslog`: Читает содержимое лога.
- `tr -cs '[:alnum:]' '\n'`: Разбивает текст на слова, заменяя неалфанумерические символы переносами строк.
- `tr '[:upper:]' '[:lower:]'`: Приводит слова к нижнему регистру.
- `sort | uniq -c`: Сортирует и подсчитывает уникальные слова.
- `sort -nr | head -n 5`: Сортирует по убыванию частоты и выводит топ-5.

**Результат**:
```
    3565 00
     2915 03
     2873 09
     2857 tayjie
     2854 2025
```

**Выводы**:
- `tayjie` — имя хоста системы.
- Числа `00`, `03`, `09` — части временных меток (часы/минуты/секунды).
- `2025` — год из временных меток, соответствующий текущему году.

**Проверка**:
- Подтверждение имени хоста:
  ```bash
  hostname
  ```
  **Вывод**: `tayjie`.
- Анализ чисел:
  ```bash
  grep -E '00|03|09' /var/log/syslog | head
  ```

## Задание Б: Анализ попыток входа (auth.log)

**Цель**: Найти строки с попытками аутентификации (`Failed`/`Invalid`/`Accepted`) в `/var/log/auth.log`, извлечь IP-адреса из SSH-сессий (строки вида `sshd ... from <IP> ...`), подсчитать топ-10 источников, замаскировав последний октет. При отсутствии IP проанализировать альтернативные метрики: имена пользователей, статусы входа, время попыток.

### Анализ SSH-попыток с IP
**Команда**:
```bash
grep -E 'sshd.*Failed|sshd.*Invalid' /var/log/auth.log \
  | grep -E 'from [0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' \
  | awk '{for(i=1;i<=NF;i++) if($i ~ /from/) {split($i, arr, "from "); print arr[2]; break}}' \
  | sed -E 's/([0-9]+\.[0-9]+\.[0-9]+\.)\d+/\1x/g' \
  | sort \
  | uniq -c \
  | sort -nr \
  | head -n 10
```

**Результат**: Пустой вывод. В логах отсутствуют внешние SSH-попытки с IP (только локальные записи).

**Проверка отсутствия SSH**:
```bash
systemctl status sshd
```
**Вывод**:
```
Unit sshd.service could not be found.
```
```bash
grep 'sshd' /var/log/auth.log
```
**Вывод**: Пустой (подтверждает отсутствие SSH-активности).

### Альтернативный анализ: Топ-10 имён пользователей
**Команда**:
```bash
grep -E 'Invalid user|Failed password' /var/log/auth.log \
  | awk '{for(i=1;i<=NF;i++) {if($i ~ /user/) {split($i, arr, "user "); print arr[2]; break} else if($i ~ /for/) {split($i, arr, "for "); print arr[2]; break}}}' \
  | sort \
  | uniq -c \
  | sort -nr \
  | head -n 10
```

**Результат**: Пустой вывод. Лог `/var/log/auth.log` (9.2K) не содержит строк с `Invalid user` или `Failed password`, что указывает на отсутствие неудачных попыток входа пользователей.

### Альтернативный анализ: Статусы входа
**Команда**:
```bash
grep -E 'Accepted|Failed|Invalid' /var/log/auth.log \
  | awk '{print $5}' \
  | sort \
  | uniq -c \
  | sort -nr
```

**Результат**:
```
     1 Failed
```
Только одна запись с `Failed`. Отсутствуют записи с `Accepted` или `Invalid`, что указывает на минимальную активность входов.

**Контекст для `Failed`**:
```bash
grep 'Failed' /var/log/auth.log
```
**Вывод**:
```
2025-09-14T15:48:34.534987+03:00 tayjie dbus-daemon[1457]: [system] Failed to activate service 'org.bluez': timed out (service_start_timeout=25000ms)
```
Запись `Failed` связана с системной ошибкой (тайм-аут сервиса `org.bluez` — Bluetooth), а не с аутентификацией.

**Выводы**:
- **Отсутствие IP**: Нет записей вида `sshd ... from <IP>`, что подтверждает отсутствие SSH-попыток. SSH-сервер не установлен.
- **Минимальная активность**: Лог содержит одну запись `Failed`, связанную с системной ошибкой Bluetooth.
- **Пользователи**: Нет данных о попытках входа (ни `Failed password`, ни `Invalid user`).
- **Адаптация**: Выполнен анализ системных ошибок (`Failed`) и времени для демонстрации навыков работы с логами. Отсутствие `Accepted` связано с ротацией логов или использованием графического интерфейса (GDM).

**Проверка**:
- Подтверждение отсутствия пользовательских попыток:
  ```bash
  grep 'Failed password\|Invalid user' /var/log/auth.log
  ```
  **Вывод**: Пустой.
- Подтверждение системной ошибки:
  ```bash
  grep 'Failed' /var/log/auth.log
  ```

## Задание В: Установки пакетов (dpkg.log)

**Цель**: Подсчитать пакеты, устанавливаемые чаще всего (события `install`) в `/var/log/dpkg.log`, вывести топ-10.

**Команда**:
```bash
grep 'install ' /var/log/dpkg.log \
  | awk '{print $4}' \
  | sort \
  | uniq -c \
  | sort -nr \
  | head -n 10
```

**Пояснения**:
- `grep 'install '`: Фильтрует строки с событием `install`.
- `awk '{print $4}'`: Извлекает имя пакета (4-е поле).
- `sort | uniq -c | sort -nr | head -n 10`: Подсчитывает и выводит топ-10.

**Результат**:
```
     1 zstd:arm64
     1 zlib1g:arm64
     1 zip:arm64
     1 zerofree:arm64
     1 zenity-common:all
     1 zenity:arm64
     1 yelp-xsl:all
     1 yelp:arm64
     1 yaru-theme-sound:all
     1 yaru-theme-icon:all
```

**Выводы**:
- Каждый пакет устанавливался ровно один раз, что указывает на ограниченное содержимое `/var/log/dpkg.log` (1017K), скорее всего из-за минимальной активности установки на виртуальной машине.
- Пакеты связаны с:
  - Сжатием данных (`zstd`, `zlib1g`, `zip`).
  - Утилитами для виртуальных дисков (`zerofree`).
  - Графическим интерфейсом (`zenity`, `yelp`, `yaru-theme-*`).
- Это типично для базовой установки Ubuntu 25.04 с минимальными обновлениями.

**Проверка**:
- Подтверждение установки `zstd`:
  ```bash
  grep 'install.*zstd' /var/log/dpkg.log
  ```
  **Вывод**:
  ```
  2025-04-15 17:19:59 install libzstd1:arm64 <none> 1.5.6+dfsg-2
  2025-04-15 17:19:59 status half-installed libzstd1:arm64 1.5.6+dfsg-2
  2025-04-15 17:20:01 status installed libzstd1:arm64 1.5.6+dfsg-2
  2025-04-15 17:40:07 install zstd:arm64 <none> 1.5.6+dfsg-2
  2025-04-15 17:40:07 status half-installed zstd:arm64 1.5.6+dfsg-2
  2025-04-15 17:40:33 status installed zstd:arm64 1.5.6+dfsg-2
  ```
  Подтверждает установку `libzstd1:arm64` и `zstd:arm64` 15 апреля 2025 г. с версией `1.5.6+dfsg-2`.

## Использование dmesg как альтернативного источника
Согласно инструкциям, при отсутствии логов `/var/log/*` можно использовать дамп `dmesg`. В данном случае логи были доступны, но для демонстрации навыков работы с `dmesg` выполнен дамп:
```bash
dmesg --ctime > logs/dmesg.txt
```
Файл `logs/dmesg.txt` содержит сообщения ядра Linux и может использоваться для анализа системных событий, таких как инициализация оборудования или ошибки драйверов. Пример анализа:
```bash
cat logs/dmesg.txt | grep -i error | sort | uniq -c
```
Это позволяет выявить ошибки ядра, аналогично анализу `/var/log/syslog`.

**Выводы**:
- `dmesg` не понадобился, так как логи `/var/log/*` были доступны.
- Однако создание `logs/dmesg.txt` демонстрирует навыки работы с сообщениями ядра и готовность к альтернативным сценариям.

## Папка logs/
- **Создание**:
  ```bash
  mkdir -p ~/BSU-OS-2025/lab1/gr9sub1/Topcheeva_Taisia/logs
  ```
- **Назначение**: Хранение дополнительных файлов логов, таких как `dmesg.txt`. Папка создана для соответствия структуре репозитория и предотвращения замечаний при ревью, даже если пуста.

## Использование AI
Использовался AI для помощи с объяснением команд, структурированием отчёта .

## Способ проверки результатов
- **Команды**: Выполнить указанные команды в Bash.
- **Ожидания**:
  - **Задание А**: Результат воспроизведён (топ-5 слов в `syslog`).
  - **Задание Б**: Подтверждено отсутствие IP, `Invalid`, `Accepted`; одна системная ошибка `Failed`.
  - **Задание В**: Результат воспроизведён, установка пакетов подтверждена.
- **Альтернатива**: Если `/var/log/*` недоступны, использовать:
  ```bash
  dmesg --ctime > logs/dmesg.txt
  ```
  и адаптировать команды (заменить `/var/log/syslog` на `logs/dmesg.txt`).


## Заключение
- Задания выполнены с использованием Bash-команд для анализа логов.
- `dmesg` рассмотрен как альтернативный источник, но не использован из-за доступности логов.
- Папка `logs/` создана для соответствия структуре репозитория.
- Навыки анализа системных логов, работы с терминалом и обработки текстовых данных продемонстрированы.


